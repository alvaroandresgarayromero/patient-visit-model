
# Nurse Workflow Application
This project is a nurse process web application for hospital organizations who would
like to optimize their employee workflow. The application at its core utilizes
the client-centered care principles of Assessment, Diagnosis, Planning, Implementation, and Evaluation
as a baseline of its main features. 

As part of the Full-Stack Udacity Nanodegree Capstone final project, 
the scope of the nurse process web application will focus on the implementation of the Assessment feature. 
This feature consists of supporting three user roles: Nurse, Patient, Admin. 
The application uses AUTH0 for authentication and permissions for the application and user.
The application uses POSTGRES DB with two main tables: visit and vitalsigns.
The visit table records the time the nurse and patient assessment occurred, and
the vital sign table records patient medical objective data such as a patient temperature. 
It is important to note that one vital sign record exist per visit. It is not possible to 
have more than one vital sign record per visit.

By completing this project, the student will have had the opportunity to implement all
concepts learned throughout the program, which include architecting relational database
models in Python, utilizing SQLAlchemy to conduct database queries, 
following RESTful principles of API development, structuring endpoints to respond to HTTP methods, 
including error handling, enabling role based authentication and roles-based access control 
with Autho0 (third-party authentication software as a service API), running Docker Containers, 
hosting the application live via Heroku,
executing unit test, creating requirements, and documentation of a web API.

[Getting Started](#Getting-Started) |
[Development Environment](#Development-Environment) |
[Web Deployment Development](#Web-Deployment-Development) | 
[Tests](#Tests) |
[BackEnd Requirements](#BackEnd-Requirements) |
[API Reference](#API-Reference) |

## Getting Started:

### Development Environment

#### Source Control

GitHub is used to maintain all required files

- Verify git is installed by checking the version. If not, install the latest git.

    ```bash
    $ git --version
    ```

- Fork and then clone the project repository 
  
    ```bash
    $ git clone https://github.com/alvaroandresgarayromero/patient-visit-model.git
    ```
#### Local Development

- Docker: Docker and Docker-Compose are utilized to create a containerized service for local development, and testing.
Currently, Docker-Compose is been used to create two containers: a web containerized service, and database containerized service.
  Furthermore, Docker-Compose also maintains the environment variables for each container. 
  
  ```bash
  NOTE: Append 'sudo' before any docker command. If you want to run docker as non-root user then you need to add your user to the docker group. 
  ```  
  
  - Verify Docker is installed by checking the version. If not, install the latest Docker
  
      ```bash
      # this project used Docker version 20.10.5
      $ docker --version
      ```
    
  - Verify Docker-Composed is installed by checking the version. If not, install the latest Docker-Composed
  
      ```bash
      # this project used docker-compose version 1.29.1
      $ docker-compose --version
      ```
    
  - Execution: Build Docker Image and Run Container
  
      ```bash
      # If the expected image does not exist then docker-compose will build a new image from DockerFile
      # Any future changes on the DockerFile will need to be manually build ($ docker-compose build) prior to executing the command below
      # Note that 'docker-compose' can detect the workspace code is modified. Therefore, the new images and container are build with the new changes
      $  docker-compose up
      ```
    
      ```bash
      # To enter Docker Web Container Flask app 
      $ docker exec -it web_container_latest /bin/bash
    
      # where 'web_container_latest' is the CONTAINER_NAME  
      # execute the command below to see the CONTAINER_NAME
      $ docker ps 
      ```
  
      ```bash
      # To enter Docker Database Container, where the password is defined in the .env file 
      $ psql -h localhost -p 5432 -d patientnursedb -U postgres --password
        Password: ${POSTGRES_PASSWORD_APP}
      ```
  
    
  - Verify Server Is Running (Quick Test)
    
    Input: 
    
      ```bash
      curl http://0.0.0.0:8080/
      ```
    
    Output: 
    
      ```json
      {
          "success": true
      }
      ```
  
  - AUTH0

    The Patient-Visit-Model application interfaces with AUTH0 to manage security concerns revolving users (registration and login), roles and permission. 
    This is accomplished with JWT user tokens that are generated by AUTH0, and consumed by the backend. Therefore, the backend requires the user JWT token in order to successfully interface with its endpoints.
    
    AUTH0 provides many methods on how to perform user login and how to get the user JWT. For local development, this application uses the 'Resource Owner Password' AUTH0 API. 
    This AUTH0 API allows the backend to directly use the users credentials (username and password) to login, and 
    respond with the JWT token in a jsonify format. 
    This method enables the backend to have no dependencies with the frontend when running automated test.
    
    ```bash
    # AUTHO Authentication API -> Get Token -> Resource Owner Password
    POST https://{AUTH0_DOMAIN}/oauth/token
    ```
    The users have already been created in AUTH0 and their credentials (username and password) are maintained in environment variables, which are located in the file shown below. 
    Note, that these users are used for local development, and automated testing purposes. In the web deployment section, we will use a more secure method to login and get the JWT token.

    ```bash
    flarkr/auth0/auth0.env
    ```
    
    For more information, about the AUTH0 configurations been used, see the 'API Reference' section.
 
#### Web Deployment Development

- Heroku: Heroku is utilized for Continuous Integration and Development (CI/CD) and Deployment.
  However, at this moment, automatic test regression has not been enabled in Heroku (because there is a cost to enable this feature). 
  Currently, Heroku is been used to create automatic builds when a push is done on git, 
  build Docker images inside Heroku, maintain the database in Heroku, and maintain the environment variables in Heroku. 
    
  - Verify Heroku is installed by checking the version. If not, install Heroku CLI
  
      ```bash
      $ heroku --version
      ```
    
  - Create a Heroku account, and then log in to Container Registry
  
      ```bash
      $ heroku container:login
      ```
  
  - Navigate to the app's directory, and create a Heroku app
  
      ```bash
      $ heroku create patient-visit-model
      ```
  
  - Create Heroku-Postgres database add-on feature
    
      ```bash
      # DATABASE_URL environment variable should automatically be created in Heroku 
      $ sudo heroku addons:create heroku-postgresql:hobby-dev --app patient-visit-model
      ```
  - Verify DATABASE_URL environment variable exists - the app uses this URL to access the database.
  
      ```bash
      # Verify DATABASE_URL exists - the app uses this URL to access the database.
      $ sudo heroku config --app patient-visit-model
      ```
    
      ```bash
      # As of 04/01/2021, the DATABASE_URL can be access in the CLI as
      $ psql -h ec2-52-87-107-83.compute-1.amazonaws.com -p 5432 -d dcaa3dle9k21qs -U ljqndisewszxtw --password
        Password: 
    
      # Where the user password will be requested. This is defined in the DATABASE_URL:
      # db_engine://user:password@host:port/database_name'
        
      ```
    
  - Deployment
  
    - Step 1: Configure our Heroku application to use Docker by manually building and deploying the image to Heroku.
      
        ```bash
        # builds docker container on heroku container registry
        $ heroku container:push web --app patient-visit-model
      
        # release the image to the app
        $ heroku container:release web --app patient-visit-model
      
        # opens web application on browser
        $ heroku open --app patient-visit-model
        ```
      
    - Step 2: Automatic Deployment - Heroku handles building the Docker Images
    
      - This is enabled with the heroku.yml file (already provided in this workspace). 
      - In Heroku, link the git repository in order to trigger automatic builds.
           
        ```bash
        # push a change to the master branch to test the automatic build.
        # For example, modify the "/verify_server_is_running" endpoint json response
        $ git push
        ```
      
- Verify Server Is Running (Quick Test)

  Input (web browser): 
  
    ```bash
    https://patient-visit-model.herokuapp.com/
    ```
  
  Output: 
  
    ```json
    {
        "success": true
    }
    ```
  
- AUTH0

    The Patient-Visit-Model application interfaces with AUTH0 to manage security concerns revolving users (registration and login), roles and permission. 
    This is accomplished with JWT user tokens that are generated by AUTH0, and consumed by the backend. Therefore, the backend requires the user JWT token in order to successfully interface with its endpoints. 
    
    AUTH0 provides many methods on how to perform user login and how to get the user JWT. For web deployment development, this application uses the 'Login: Social' AUTH0 API. 
    This AUTH0 API is a secure method that allows the backend to not maintain user credentials (username and password) to login. 
    This type of authentication is known as a social connection which is browser-based authentication only. 
    In this case, the user were registered in AUTH0. Therefore, users are redirected to the AUTH0 LOGIN URL PAGE to login, and then a call-back URL provides the user JWT token.
    This method adds some overhead to the backend, but enables no dependencies with user credentials. 
  
    ```bash
    # AUTHO Authentication API -> Login -> Social
    https://{AUTH0_DOMAIN}//authorize
    ```
  - AUTH0 LOGIN PAGE:
    - Step 1: The following script will generate the required URL to access the '/authorize' AUTH0 API endpoint in order to LOGIN a user into AUTH0 LOGIN PAGE
      
      ```bash
      $ source flaskr/auth0/auth0LoginBrowser.sh 
      ```
      
    - Step 2: Copy the URL, and paste it into your desired web-browser.
      
  - GET NEW USER JWT TOKEN:
    - Step 1: Go to the AUTH0 LOGIN PAGE 
    - Step 2: Login with one of the 'Registered AUTH0 User' credentials, which can be found in the file below.
  
      ```bash
      flarkr/auth0/auth0.env
      ```
      
    - Step 3: Upon successful login, AUTH0 will generate a callback URL that has an access_token variable with the JWT token data.
    
  - About SETUP.SH:
    
    This bash file is for Udacity reviewers as part of the grading requirement. 
    It holds the AUTH0 configurations used by the application running on Heroku, as well as some valid user JWT tokens that 
    were generated right before submitting the project for grading. 
    
    For more information, about the AUTH0 configurations been used, see the 'API Reference' section.
  
### Tests

Tests are defined in the requirement section. 

## BackEnd Requirements:

Requirements are organized in three sections where the keyword "context" on requirement IDs are descriptions.

- Software Requirement Design (SRD) - Provides high level user-facing design requirements where all SRDs are reusable and portable into any other framework.
- Software Requirement Specification (SRS) - Provides high level system/technical requirements that satisfy SRDs, and are testable where most, but not all SRSs are reusable and portable into any other framework.
- Software Test Procedure (STP) - Provides test procedures requirements that satisfies SRSs, and contain quantifiable metrics that result on the test to PASS or FAIL.  

### SRD

- SRD_01 - Requirement:
  - The software shall provide a method to 
    support three client types: Patient, Nurse, Admin
- SRD_02 - Context:
  - Medical Data refers to
    - assessment data such as vital signs
    - administrative data such as who was the patient, who was the nurse, what time did they interact. 
- SRD_03 - Requirement:
  - The software shall provide an Admin client permission 
    to create, read, update, and delete medical data
- SRD_04 - Requirement:
  - The software shall provide a Nurse client permission to 
    create, read, and update medical data
- SRD_05 - Requirement:
  - The software shall provide a Patient client permission to 
    read their own medical data
- SRD_06 - Requirement:
  - The software shall provide a client with a 
    method to document a visitation encounter with a patient client. 
- SRD_07 - Requirement:
  - The software shall provide a client with a 
    method to document the vital signs of a patient client.  
- SRD_08 - Requirement:
  - The software shall provide a client with a 
    method to read medical data of a patient client.
- SRD_09 - Requirement:
  - The software shall provide a client with a 
    method to update existing medical data of a patient client.    
- SRD_10 - Requirement:
  - The software shall provide a client with a 
    method to delete existing medical data of a patient client.    
        

### SRS
- SRS_01 - Requirement: 
  - Satisfies: SRD_01, SRD_03, SRD_04, SRD_05
  - The software shall interface with AUTH0 API to manage Patient, Nurse, and Admin clients identity, and permissions
    during POST, GET, PATCH, and DELETE request commands.
- SRS_02 - Requirement: 
  - Satisfies: SRD_03
  - The software shall permit POST, GET, PATCH, and DELETE requests during Admin clients request commands
- SRS_03 - Requirement: 
  - Satisfies: SRD_04
  - The software shall permit POST, GET, and PATCH requests during Nurse clients request commands
- SRS_04 - Requirement: 
  - Satisfies: SRD_05
  - The software shall permit GET requests during Patient clients request commands
- SRD_05 - Context:
  - A visit record is composed of a Patient, Nurse, and Date of encounter.
- SRS_06 - Requirement: 
  - Satisfies: SRD_06
  - The software shall create visit records
    during '/visits/create' POST request commands
- SRS_07 - Requirement: 
  - Satisfies: SRD_06, SRD_09
  - The software shall update a visit record 
    during '/visits/<int:value>' PATCH request commands
- SRS_08 - Requirement: 
  - Satisfies: SRD_06, SRD_10
  - The software shall delete a visit record 
    during '/visits/<int:value>' DELETE request commands
- SRD_09 - Context:
  - A vital sign record is composed of a patient temperature.
- SRD_10 - Context:
  - A patient record is composed of vital sign and visit records. 
- SRS_11 - Requirement: 
  - Satisfies: SRD_07
  - The software shall create vital sign records
    during '/vital-signs/create' POST request commands
- SRS_12 - Requirement: 
  - Satisfies: SRD_06, SRD_07, SRD_08
  - The software shall respond with a patient record
    during '/patients/<int:value>' GET request commands
- SRS_13 - Requirement: 
  - Satisfies: SRD_07, SRD_09
  - The software shall update a vital sign record 
    during '/vital-signs/<int:value>' PATCH request commands
- SRS_14 - Requirement: 
  - Satisfies: SRD_07, SRD_10
  - The software shall delete a vital sign record 
    during '/vital-signs/<int:value>' DELETE request commands
- SRS_15 - Requirement: 
  - Satisfies: SRD_06, SRD_07, SRD_08
  - The software shall respond with a patient record
    during '/patients/search' GET request commands
- SRS_16 - Requirement: 
  - Satisfies: SRD_05, SRD_08
  - The software shall respond with the active patient user record
    during '/patients/search/user' GET request commands

### STP

- STP_00 - Context

  A test must complete the test suite with no errors in order to be considered a PASS. 
  A test suite that does not complete the entirety of the test is considered a FAILURE.
  
    - Step 1: 
  
      ```bash
      #In app/backend/, create and run the docker container. 
      $ docker-compose up
      ```
      NOTE: At the beginning of time, docker will create and initialize a test database container.
      This test container is populated with sql data. This is done in order to support tests
      that require data to be already in the database.
      
      - [optional] Update SQL data that is loaded into database test container:
      
        ```bash
        # SQL data file that is read by the test database container
        $ flaskr/db/nurse-patient.sql
        ```
  
        ```bash
        # Create new "nurse-patient.sql' file. 
        # In this example, the sql data in the docker container with PORT 5432 
        # is dumped to the tester local computer. 
        $ pg_dump patientnursedb --host localhost --port 5432 --username postgres > nurse-patient.sql
          Password: ${POSTGRES_PASSWORD_APP}
      
        # NOTE: where the password is defined in the .env file
        # NOTE: postgres versions from container and the local computer must be the same 
        #       or else a miss-match error will occur. 
        # NOTE: the nurse-patient.sql must be placed in the path that docker is looking for. 
        ```
        
        ```bash
        # Remove the test database container in order to trigger a new initialization process,
        # and then create/run the container. The container name is defined in the .env file.
        $ docker container rm ${POSTGRES_CONTAINER_NAME_TEST}
        $ docker-compose up
        ```
      
        ```bash
        # Enter the test database container to verify the data is there, where the password is defined in the .env file
        $ psql -h localhost -p 5433 -d patientnursedb -U postgres --password
          Password: ${POSTGRES_PASSWORD_APP}
        ```
        
    - Step 2: Enter the web docker container
      
      ```bash
      $ docker exec -it web_container_latest /bin/bash
      ```
         
    - Step 3: Run the tests inside the docker container 
      
        - To run individual tests, follow the ‘STP-XX Requirement’ instructions
      
        ```bash
        $ python3 -m unittest test_flaskr.PatientVisitTestCase.<STP_XX>
        ```  
      
        - Otherwise, to execute all tests run:
      
        ```bash
        $ python3 test_flaskr.py
        ```
      
- STP_01 - Requirement
  - Satisfies: SRS_01, SRD_02
  - Verify that the software can access the expected
    endpoints during Admin client request commands as specified below.
      - POST '/visits/create' endpoint
      - PATCH and DELETE '/visits/<int:value>' endpoints
      - POST '/vital-signs/create' endpoint
      - PATCH, DELETE '/vital-signs/<int:value>' endpoints
      - GET '/patients/search' endpoint

  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_01
      ```  
    - Pass/Fail results will be displayed on the command line
- STP_01_a - Requirement
  - Satisfies: SRS_01, SRD_02
  - Verify that the software asserts when accessing unauthorized 
    endpoints during Admin client request commands as specified below.
      - GET '/patients/search/user' endpoint

  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_01_a
      ```  
    - Pass/Fail results will be displayed on the command line
  
- STP_02 - Requirement
  - Satisfies: SRS_01, SRD_03
  - Verify that the software can access the expected 
    endpoints during Nurse client request commands as specified below.
      - POST '/visits/create' endpoint
      - PATCH '/visits/<int:value>' endpoints
      - POST '/vital-signs/create' endpoint
      - PATCH '/vital-signs/<int:value>' endpoints
      - GET '/patients/search' endpoint

  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_02
      ```  
    - Pass/Fail results will be displayed on the command line
  
- STP_03 - Requirement
  - Satisfies: SRS_01, SRD_03
  - Verify that the software asserts when accessing unauthorized 
    endpoints during Nurse client request commands as specified below.
      - DELETE '/visits/<int:value>' endpoints 
      - DELETE '/vital-signs/<int:value>' endpoints
      - GET '/patients/search/user' endpoint

  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_03
      ```  
    - Pass/Fail results will be displayed on the command line
  
- STP_04 - Requirement
  - Satisfies: SRS_01, SRS_04
  - Verify that the software can access the expected 
    endpoints during Patient client request commands as specified below.
      - GET '/patients/search/user' endpoint
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_04
      ```  
    - Pass/Fail results will be displayed on the command line
  
- STP_05 - Requirement
  - Satisfies: SRS_01, SRS_04
  - Verify that the software asserts when accessing unauthorized  
    endpoints during Patient client request commands as specified below.
      - POST '/visits/create' endpoint
      - PATCH and DELETE '/visits/<int:value>' endpoints
      - POST '/vital-signs/create' endpoint
      - PATCH, DELETE '/vital-signs/<int:value>' endpoints
      - GET '/patients/search' endpoint
    
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_05
      ```  
    - Pass/Fail results will be displayed on the command line
  
- STP_06 - Requirement
  - Satisfies: SRS_06
  - Verify that the software creates a visit record 
    during ‘/visits/create’ POST request commands.
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_06
      ```  
    - Pass/Fail results will be displayed on the command line
  
- STP_07 - Requirement
  - Satisfies: SRS_06
  - Verify that the software asserts
    during incorrect ‘/visits/create’ POST request commands.
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_07
      ```  
    - Pass/Fail results will be displayed on the command line
  
- STP_08 - Requirement
  - Satisfies: SRS_07
  - Verify that the software updates a visit record 
    during ‘/visits/<int:a_id>’ PATCH request commands.
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_08
      ```
    - Pass/Fail results will be displayed on the command line
      
- STP_09 - Requirement
  - Satisfies: SRS_07
  - Verify that the software asserts
    during incorrect ‘/visits/<int:a_id>’ PATCH request commands.
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_09
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_10 - Requirement
  - Satisfies: SRS_08
  - Verify that the software deletes a visit record
    during '/visits/<int:value>' DELETE request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_10
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_11 - Requirement
  - Satisfies: SRS_08
  - Verify that the software asserts
    during incorrect '/visits/<int:value>' DELETE request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_11
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_12 - Requirement
  - Satisfies: SRS_11
  - Verify that the software creates vital sign records
    during '/vital-signs/create' POST request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_12
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_13 - Requirement
  - Satisfies: SRS_11
  - Verify that the software asserts
    during '/vital-signs/create' POST request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_13
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_14 - Requirement
  - Satisfies: SRS_13
  - Verify that the software updates a vital sign record 
    during '/vital-signs/<int:value>' PATCH request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_14
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_15 - Requirement
  - Satisfies: SRS_13
  - Verify that the software assert
    during '/vital-signs/<int:value>' PATCH request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_15
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_16 - Requirement
  - Satisfies: SRS_14
  - Verify that the software deletes vital sign record
    during '/vital-signs/<int:value>' DELETE request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_16
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_17 - Requirement
  - Satisfies: SRS_14
  - Verify that the software assert
    during '/vital-signs/<int:value>' DELETE request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_17
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_18 - Requirement
  - Satisfies: SRS_12
  - Verify that the software retrieves patient data
    during '/patients/search' GET request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_18
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_19 - Requirement
  - Satisfies: SRS_12
  - Verify that the software asserts
    during '/patients/search' GET request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_19
      ```
    - Pass/Fail results will be displayed on the command line
  
- STP_20 - Requirement
  - Satisfies: SRS_16
  - Verify that the software retrieves the active user patient data
    during '/patients/search/user' GET request commands
  - Description:
    - Execute steps in STP_00 to configure the test system for testing
    - Run:
      ```bash
      $ python3 -m unittest test_flaskr.StpRunner.STP_20
      ```
    - Pass/Fail results will be displayed on the command line

## API Reference:

### Getting Started

#### Base URL

- Local Host:
  
    Hosted in a Docker Container as defined by the web service in docker-compose.yml
  
    ```bash
    $ curl http://0.0.0.0:8080/
    ```
  
- Web Host: 
  
    Hosted in Heroku using free web dyno. 
    This means that the app will go to sleep if inactive for 30 minutes. 
    Upon incoming traffic, then it will be woken up after a short delay.

    ```bash
    https://patient-visit-model.herokuapp.com/
    ```
  
#### AUTH0 Configurations 

The backend utilizes AUTH0 for application authorization, user permissions, and user information.

AUTH0 is a third party platform that securely manages users, and their private information. 
Thus, allowing us not to worry about managing the security concerns when it comes to keeping users data safe. 
AUTH0 generated JSON-WEB-TOKEN (JWT) and AUTH0 API enables external applications (like this one) to interface with them, and utilize their security features.

Currently, the frontend is not supported. 
However, when it is supported, then it would provide support for a user to register into the AUTH0 app, and then login through the AUTH0 LOGIN page.
Upon successful user login, a JSON WEB TOKEN (JWT) is generated by AUTH0, and passed to the front-end. 
When the logged-in user triggers a backend endpoint, then the user's JWT gets decrypted, and then verified with the AUTH0 API to determined if the JWT is healthy, and has not been manipulated/tinkered. 
Upon successful authorization, then the payload data in the JWT is utilized to check whether the user has permission to access the requested end-point. 
In addition, the JWT can be used to request more detail information about the active user through the AUTH0 API.

Currently, two AUTH0 applications have been configured where both share the same API (permissions), roles and users. 
- AUTH0 for Local Development: It is a machine to machine AUTH0 APP, which is used for local development.
- AUTH0 for Web Deployment Development: It is regular web application AUTH0 APP, which is used for deployment in Heroku.

Both AUTH0 applications are identical in configurations. 
The main difference between them is the host address: Local host vs web host, and the application unique identity such as the Client ID and Client Secret

- Local Development AUTH0 Application: See flaskr/autho0/auth0.env for environment variables
  - Name: PatientVisit (Test Application)
  - Domain: $AUTH0_DOMAIN
  - Client ID (autogenerated unique identification): $AUTH0_CLIENT_ID   
  - Client Secret (autogenerated unique identification): $AUTH0_CLIENT_SECRET
  - Application Type: Machine to Machine
  - Token Endpoint Authentication Method: POST
  - Application Login URI: https://<docker_backend_domain>/login
  - Allowed Callback URLs (required to get JWT from URL): https://<docker_backend_domain>/login-results
  - Allowed Logout URLs: https://<docker_backend_domain>/logout 
  - To interface successfully with https://{AUTH0_DOMAIN}/oauth/token, the following settings must be configured:
    - Client Application settings: 
      ```bash
      Applications -> Settings -> Advanced Settings -> Grant Types : Password
      ```
    - Tenant Settings: (Under tenant user account -> settings) 
      ```bash
      Set General -> API Authorization Settings ->Default Directory : Username-Password-Authentication
      ```
 
- Web Deployment Development AUTH0 Application: See flaskr/autho0/setup.sh for environment variables
  - Name: PatientVisitModel
  - Domain: $AUTH0_DOMAIN
  - Client ID (autogenerated unique identification): $AUTH0_CLIENT_ID
  - Client Secret (autogenerated unique identification): $AUTH0_CLIENT_SECRET
  - Application Type: Regular Web Application
  - Token Endpoint Authentication Method: POST
  - Application Login URI: https://<heroku_frontend_domain>/login
  - Allowed Callback URLs (required to get JWT from URL): https://<heroku_frontend_domain>/login-results
  - Allowed Logout URLs: https://<heroku_frontend_domain>/logout 

- API:  See flaskr/autho0/setup.sh for environment variables
  - ID (autogenerated): ******
  - Name: PatientVisit  
  - Identifier: $AUTH0_AUDIENCE 
  - Enable RBAC: On
  - Add Permissions in the Access Token: On
  
- Permissions: 
  - patch:visits: Updates visit record	
  - post:visits: Creates new visit record for patient-nurse encounter 
  - delete:visits: Deletes visit record	
  - post:vital-signs: Creates new vital sign record	
  - patch:vital-signs: Updates vital sign record	
  - delete:vital-signs: Deletes vital sign record 
  - read:patient-data: Reads patient data (visits and vital sign data)	
  - read:restrictive-patient-data: Reads patient data (visits and vital sign data)

- Roles
  - Admin: 
    - patch:visits
    - post:visits:
    - delete:visits
    - post:vital-signs
    - patch:vital-signs
    - delete:vital-signs
    - read:patient-data
  - Nurse: 
    - patch:visits
    - post:visits:
    - post:vital-signs
    - patch:vital-signs
    - read:patient-data
  - Patient:
    - read:restrictive-patient-data

- Users: In addition, 5 AUTH0 users have been pre-registered. 
  To see their credentials see the flaskr/auth0/auth0.env file:

  
Lastly, AUTH0 provides their own management API to interact with the users and roles. For instance, searching a particular user, decoding user id, etc.
In order to interface with the AUTH0 management API, a special management token is required. This token contains permissions to access the 
AUTH0 API endpoints. Support to fetch within python is provided in the file below:

```bash
flaskr/auth0/authManagementAPI.py
```
  

#### Error Handling

  Errors are returned as JSON objects in the following format:

  ```json
  {
      "success": false, 
      "error": 400,
      "message": "bad request"
  }
  ```

  The API will return three error types when requests fail

   - 400: Bad Request
   - 401: Unauthorized
   - 404: Resource Not Found
   - 422: Not Processable

#### Resource endpoint library

There are three main environment variables that need to be 
initialized prior to running the curl endpoint examples. 
These environment variables are located in the setup.sh file. 

- $BASE_URL - This is the base URL as described in the 'Base URL' section. 
By Default, the BASE_URL is hosted by Heroku

- $ADMIN_TOKEN - This is the ADMIN user JWT token
  
- $PATIENT1_TOKEN - This is a PATIENT user JWT token


- Verify the following steps:

  - Step 1: source the setup.sh bash file.
  
      ```bash
      # initializes environment variables 
      source flaskr/auth0/setup.sh
      ```
    
  - Step 2: If the users JWT tokens have expired, then a new one
  can be generated. 
    
      ```bash
      # get URL to login. 
      # The file will echo the URL on the terminal. 
      # Copy the URL and paste it in a browser.    
      source flaskr/auth0/auth0LoginBrowser.sh
      ```
    
       ```bash
      # In the browser, the auth0 user credential will be requested. 
      flaskr/auth0/setup.sh
      ```
    
       ```bash
      # Update the JWT token environment variable with the new JWT token 
      # In flaskr/auth0/setup.sh.
      # Note don't forget to source the file for the update to be configured 
      source flaskr/auth0/setup.sh
      ```


- Notes to developer:
  - A visit record can only have one vital sign record
  - A visit record can't be deleted if it has an existing vital sign record


- Notes before experimenting with curl commands:
  - The examples have been organized in the following order in order
    to provide a smooth experience with the examples
    - create
    - update
    - read
    - delete
  

- POST /visits/create

  - General: 
    - Creates a new visit record
  - JSON Request Arguments:
    - nurse_id [string] : AUTH0 ID of nurse
    - patient_id [string] : AUTH0 ID of patient
  - Permission:
    - POST:VISITS
  - Return: 
    - Returns a dictionary with information about the recently created visit record.
  
  - Sample Input:
  
    ```bash
    curl --request POST --url $BASE_URL/visits/create \
    --header "Authorization: Bearer $ADMIN_TOKEN" \
    --header "Content-Type: application/json" \
    --data '{"nurse_id":"auth0|60afcac9402eb000684ef198", "patient_id":"auth0|609584b8abea8d006a4dd478"}'
    ```
  - Output: 
    
    ```json
    {
      "data": {
        "id": 1, 
        "nurse_id": "auth0|60afcac9402eb000684ef198", 
        "nurse_name": "Jonny Harper, RN", 
        "patient_id": "auth0|609584b8abea8d006a4dd478", 
        "patient_name": "Jose Garay", 
        "visit_time": "05/27/2021, 18:50:08"
      }, 
      "success": true
    }
    ```


- POST /vital-signs/create

  - General: 
    - Creates a new vital sign record
    - NOTE: A visit record id is required, and it must not already
    be in use with a vital sign record
  - JSON Request Arguments:
    - visit_id [string] : Visit record unique id numerical number
    - tempCelsius [string] : Patient temperature numerical number in celsious   
  - Permission:
    - POST:VITAL-SIGNS
  - Return: 
    - Returns a dictionary with information about the recently created vital sign record.
  
  - Sample Input:
  
    ```bash
    curl --request POST --url $BASE_URL/vital-signs/create \
    --header "Authorization: Bearer $ADMIN_TOKEN" \
    --header "Content-Type: application/json" \
    --data '{"visit_id":"1", "tempCelsius":"37"}'
    ```
  - Output: 
    
    ```json
    {
      "data": {
        "id": 1, 
        "tempCelsius": 37, 
        "visit_id": 1
      }, 
      "success": true
    }
    ```
    

- PATCH /visits/{int:visit_id}

  - General: 
    - Updates an existing visit record
  - Variable Rule Argument
    - visit_id [integer] : Visit record ID from the Visit table
  - JSON Request Arguments:
    - nurse_id [string] : AUTH0 ID of nurse to update
    - patient_id [string] : AUTH0 ID of patient to update
  - Permission:
    - PATCH:VISITS
  - Return: 
    - Returns a dictionary with information about the recently updated visit record.
  
  - Sample Input:
  
    ```bash
    # Update record visit "1" with new patient_id
    # Keep existing nurse_id by not adding it into the data dictionary
    curl --request PATCH --url $BASE_URL/visits/1 \
    --header "Authorization: Bearer $ADMIN_TOKEN" \
    --header "Content-Type: application/json" \
    --data '{"patient_id":"auth0|609584e057af210069a6e4f1"}'
    ```
  - Output: 
    
    ```json
    {
      "data": {
        "id": 1, 
        "nurse_id": "auth0|60afcac9402eb000684ef198", 
        "nurse_name": "Jonny Harper, RN", 
        "patient_id": "auth0|609584e057af210069a6e4f1", 
        "patient_name": "Cuzco Dog", 
        "visit_time": "05/28/2021, 03:32:48"
      }, 
      "success": true
    }
    ```


- PATCH /vital-signs/{int:vitalsign_id}

  - General: 
    - Updates an existing vital sign record
  - Variable Rule Argument
    - vitalsign_id [string] : Vital sign unique id number number
  - JSON Request Arguments:
    - visit_id [string] : Visit record unique id numerical number to update
    - tempCelsius [string] : Patient temperature numerical number in celsious to update   
  - Permission:
    - PATCH:VITAL-SIGNS
  - Return: 
    - Returns a dictionary with information about the recently updated vital sign record.
  
  - Sample Input:
  
    ```bash
    # Update record vitalsign "1" with new patient temperature
    # Keep existing visit_id by not adding it into the data dictionary
    curl --request PATCH --url $BASE_URL/vital-signs/1 \
    --header "Authorization: Bearer $ADMIN_TOKEN" \
    --header "Content-Type: application/json" \
    --data '{"tempCelsius":"100"}'
    ```
  - Output: 
    
    ```json
    {
      "data": {
        "id": 1, 
        "tempCelsius": 100, 
        "visit_id": 1
      }, 
      "success": true
    }
    ```
  
- GET /patients/search

  - General: 
    -  Get the visits and vital signs of a requested patient
  - JSON Request Arguments:
    - patient_id [string] : AUTH0 ID of patient to get
  - Permission:
    - READ:PATIENT-DATA
  - Return: 
    - Returns a dictionary with information about the visits and vital signs of the requested patient
  
  - Sample Input:
  
    ```bash
    curl --request GET --url $BASE_URL/patients/search \
    --header "Authorization: Bearer $ADMIN_TOKEN" \
    --header "Content-Type: application/json" \
    --data '{"patient_id":"auth0|609584e057af210069a6e4f1"}'
    ```
  - Output: 
    
    ```json
    {
      "data": [
        {
          "visit": {
            "id": 1, 
            "nurse_id": "auth0|60afcac9402eb000684ef198", 
            "nurse_name": "Jonny Harper, RN", 
            "patient_id": "auth0|609584e057af210069a6e4f1", 
            "patient_name": "Cuzco Dog", 
            "visit_time": "05/28/2021, 03:32:48"
          }, 
          "vitalSign": {
            "id": 1, 
            "tempCelsius": 100, 
            "visit_id": 1
          }
        }
      ], 
      "success": true
    }

    ```
    
    
- GET /patients/search/user

  - General: 
    -  Get the visits and vital signs of a logged in patient user
  - JSON Request Arguments:
    - NONE
  - Permission:
    - READ:RESTRICTIVE-PATIENT-DATA 
  - Return: 
    - Returns a dictionary with information about the visits and vital signs of the active patient user
  
  - Sample Input:
  
    ```bash
    curl --request GET --url $BASE_URL/patients/search/user \
    --header "Authorization: Bearer $PATIENT2_TOKEN"
    ```
  - Output: 
    
    ```json
    {
      "data": [
        {
          "visit": {
            "id": 1, 
            "nurse_id": "auth0|60afcac9402eb000684ef198", 
            "nurse_name": "Jonny Harper, RN", 
            "patient_id": "auth0|609584e057af210069a6e4f1", 
            "patient_name": "Cuzco Dog", 
            "visit_time": "05/28/2021, 03:32:48"
          }, 
          "vitalSign": {
            "id": 1, 
            "tempCelsius": 100, 
            "visit_id": 1
          }
        }
      ], 
      "success": true
    }
    ```
  

- DELETE /vital-signs/{int:vitalsign_id}

  - General: 
    - Deletes an existing vital sign record
  - Variable Rule Argument
    - vitalsign_id [string] : Vital sign unique id number number
  - Permission:
    - DELETE:VITAL-SIGNS
  - Return: 
    - Returns a dictionary with information about the recently deleted vital sign record.
  
  - Sample Input:
  
    ```bash
    curl --request DELETE --url $BASE_URL/vital-signs/1 \
    --header "Authorization: Bearer $ADMIN_TOKEN" 
    ```
  - Output: 
    
    ```json
    {
      "success": true, 
      "vitalsign_id": 1
    }
    ```
    
- DELETE /visits/{int:visit_id}

  - General: 
    - Deletes an existing visit record
  - Variable Rule Argument
    - visit_id [integer] : Visit record ID from the Visit table
  - Permission:
    - DELETE:VISITS
  - Return: 
    - Returns a dictionary with information about the recently deleted visit record.
  
  - Sample Input:
  
    ```bash
    curl --request DELETE --url $BASE_URL/visits/1 \
    --header "Authorization: Bearer $ADMIN_TOKEN" 
    ```
  - Output: 
    
    ```json
    {
      "success": true, 
      "visit_id": 1
    }
    ```